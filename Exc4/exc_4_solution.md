## Архитектурное решение по логированию

### Анализ системы и необходимые логи

Логирование необходимо внедрить в следующих системах:

*   **Internet Shop**
*   **Shop API**
*   **Shop DB**
*   **CRM**
*   **CRM API**
*   **MES API**
*   **MES**
*   **Messages Queue**
*   **3d files storage**

#### Список необходимых логов уровня INFO:

1. **Internet Shop:**
    *   Вход/выход пользователя (время, идентификатор пользователя).
    *   Добавление товара в корзину (время, идентификатор пользователя, идентификатор товара, количество).
    *   Создание нового заказа (время, идентификатор пользователя, состав заказа).
    *   Загрузка файла с 3D-моделью (время, идентификатор пользователя, номер заказа, размер файла).
    *   Использование конструктора 3D-моделей (время, идентификатор пользователя, номер заказа, используемые элементы).
    *   Подтверждение заказа (время, идентификатор пользователя, номер заказа).
2. **Shop API:**
    *   Получение запроса на создание заказа (время, идентификатор пользователя, данные запроса).
    *   Сохранение информации о заказе (время, идентификатор пользователя, номер заказа).
    *   Взаимодействие с Shop DB (время, номер заказа, SQL-запрос).
    *   Получение списка товаров (время, параметры запроса).
    *   Получение 3d модели (время, номер заказа).
    *   Отправка 3d модели в 3d files storage (время, номер заказа).
3. **Shop DB:**
    *   Изменение статуса заказа (время, номер заказа, старый статус, новый статус).
    *   Добавление нового пользователя (время, идентификатор пользователя).
    *   Добавление нового товара (время, идентификатор товара).
4. **CRM:**
    *   Вход/выход пользователя (время, идентификатор пользователя).
    *   Подтверждение заказа (время, идентификатор пользователя, номер заказа).
    *   Закрытие заказа (время, идентификатор пользователя, номер заказа).
5. **CRM API:**
    *   Получение запроса на подтверждение заказа (время, идентификатор пользователя, номер заказа).
    *   Взаимодействие с Shop DB (время, номер заказа, SQL-запрос).
    *   Отправка сообщения в RabbitMQ (время, номер заказа, статус заказа).
6. **MES API:**
    *   Получение запроса на расчет стоимости (время, номер заказа, данные запроса).
    *   Взаимодействие с 3d files storage (время, номер заказа).
    *   Расчет стоимости заказа (время, номер заказа, стоимость).
    *   Отправка сообщения в RabbitMQ (время, номер заказа, статус заказа).
    *   Взаимодействие с MES DB (время, номер заказа, SQL-запрос).
7. **MES:**
    *   Вход/выход пользователя (время, идентификатор пользователя).
    *   Назначение заказа на оператора (время, идентификатор пользователя, номер заказа).
    *   Изменение статуса заказа (время, идентификатор пользователя, номер заказа, старый статус, новый статус).
8. **Messages Queue:**
    *   Получение сообщения (время, идентификатор сообщения, тип сообщения, статус заказа).
    *   Отправка сообщения (время, идентификатор сообщения, тип сообщения, статус заказа).
9. **3d files storage:**
    *   Загрузка файла (время, номер заказа, размер файла).
    *   Удаление файла (время, номер заказа).

#### Другие уровни логирования:

*   **DEBUG:**
    -   Детальная информация о ходе выполнения операций, например, промежуточные результаты расчетов, значения переменных.
    -   Использовать во время разработки и отладки.
*   **WARNING:**
    -   Непредвиденные ситуации, которые не приводят к ошибке, но могут указывать на потенциальные проблемы.
    -   Например, превышение времени ожидания ответа от внешнего сервиса.
*   **ERROR:**
    -   Ошибки, которые приводят к сбою в выполнении операции.
    -   Например, ошибка подключения к базе данных, ошибка при обработке запроса.
*   **CRITICAL:**
    -   Критические ошибки, которые приводят к неработоспособности системы.
    -   Например, падение приложения, потеря данных.

### Мотивация

Логирование необходимо для обеспечения наблюдаемости системы, быстрого выявления и устранения проблем, а также для улучшения качества обслуживания клиентов.

**Технические метрики:**

1. **Mean Time To Detect (MTTD):** Среднее время обнаружения проблемы. Логирование позволит быстрее обнаруживать ошибки и аномалии в работе системы.
2. **Mean Time To Resolve (MTTR):** Среднее время решения проблемы. Детальные логи помогут быстрее локализовать и устранить причину сбоя.
3. **Error Rate:** Частота возникновения ошибок. Логирование позволит отслеживать количество ошибок и выявлять наиболее проблемные места в системе.

**Бизнес-метрики:**

1. **Customer Satisfaction (CSAT):** Удовлетворенность клиентов. Сокращение времени простоя и быстрое решение проблем повысят удовлетворенность клиентов.
2. **Order Processing Time:** Время обработки заказа. Логирование поможет выявить узкие места в процессе обработки заказа и оптимизировать его.

#### Приоритезация

В первую очередь необходимо настроить логирование и трейсинг для следующих систем:

1. **MES API и MES:** Эти системы отвечают за расчет стоимости и управление производством. Ошибки в них приводят к задержкам заказов и финансовым потерям.
2. **Shop API и Shop DB:** Эти системы отвечают за прием и хранение заказов. Проблемы в них приводят к потере заказов и недовольству клиентов.
3. **Messages Queue:** Очередь сообщений является связующим звеном между системами. Логирование сообщений позволит отслеживать ход выполнения заказа и выявлять проблемы во взаимодействии между системами.

### Предлагаемое решение

#### Технологии

*   **Сбор логов:** Logstash для сбора и агрегации логов из разных источников.
*   **Хранение логов:** Elasticsearch для хранения и индексирования логов.
*   **Визуализация логов:** Kibana для визуализации и анализа логов.
*   **Трейсинг:** Jaeger для трассировки распределенных запросов.

#### Компоненты

*   **Агенты сбора логов:** Устанавливаются на серверы с приложениями и собирают логи из файлов или системных журналов.
*   **Агрегатор логов:** Принимает логи от агентов, обрабатывает их и отправляет в хранилище.
*   **Хранилище логов:** Хранит и индексирует логи для быстрого поиска и анализа.
*   **Инструмент визуализации:** Предоставляет интерфейс для просмотра, поиска и анализа логов.

#### Политика безопасности

*   **Доступ к логам:** Доступ к логам должен быть ограничен. Только авторизованные пользователи (разработчики, DevOps, служба поддержки) должны иметь доступ к логам.
*   **Чувствительные данные:** Чувствительные данные (пароли, персональные данные) не должны попадать в логи. Необходимо использовать маскирование или шифрование для защиты чувствительных данных.
*   **Аудит доступа:** Все действия с логами должны аудироваться.

#### Политика хранения

*   **Индексы:** Для каждой системы создается отдельный индекс в Elasticsearch.
*   **Срок хранения:** Логи хранятся в течение 30 дней. Старые логи удаляются автоматически.
*   **Размер:** Размер логов контролируется. При достижении определенного порога старые логи удаляются или архивируются.

### Мероприятия для превращения системы сбора логов в систему анализа логов

#### Алертинг

*   Настроить оповещения о критических ошибках и аномалиях в работе системы.
*   Оповещения отправляются по электронной почте или в мессенджер (например, Slack).
*   Примеры алертов:
    *   Превышение допустимого количества ошибок за определенный период времени.
    *   Падение приложения.
    *   Недоступность базы данных.

#### Поиск аномалий

*   Использовать инструменты Elasticsearch для выявления аномалий в логах.
*   Примеры аномалий:
    *   Резкое увеличение количества заказов.
    *   Необычно большое количество ошибок от определенного пользователя.
    *   Длительное время выполнения запроса.

#### Дашборды

*   Создать дашборды в Kibana для мониторинга ключевых метрик системы.
*   Дашборды должны отображать информацию о количестве заказов, ошибках, времени выполнения запросов и других важных параметрах.
