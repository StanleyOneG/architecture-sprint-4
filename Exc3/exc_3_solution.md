## Архитектурное решение по трейсингу

### Системы, которые следует покрыть трейсингом

Для эффективного трейсинга необходимо покрыть следующие системы:

- **Shop API**: Обрабатывает запросы от пользователей, взаимодействует с базой данных магазина и очередью сообщений.
- **CRM API**: Обрабатывает запросы от операторов, взаимодействует с базой данных магазина и очередью сообщений.
- **MES API**: Обрабатывает запросы от операторов, взаимодействует с очередью сообщений, базой данных MES и хранилищем файлов.

Эти системы были выбраны, потому что именно в них наиболее вероятны проблемы с заказами:

- **Shop API** и **CRM API** являются точками входа для пользовательских запросов и могут быть подвержены ошибкам при обработке данных или взаимодействии с базой данных.
- **MES API** отвечает за расчет стоимости заказа и его назначение на операторов, что является критически важным процессом.

### Данные для трейсинга

В трейсинг должны попадать следующие данные:

- **Идентификатор заказа**: Уникальный идентификатор заказа, позволяющий отслеживать его прохождение по системе.
- **Временные метки**: Время начала и окончания обработки заказа на каждом этапе.
- **Статус заказа**: Текущий статус заказа (`INITIATED`, `FILE_UPLOADED`, `SUBMITTED`, `PRICE_CALCULATED`, `MANUFACTURING_APPROVED`, `MANUFACTURING_STARTED`, `MANUFACTURING_COMPLETED`, `PACKAGING`, `SHIPPED`, `CLOSED`).
- **Идентификаторы пользователей**: Идентификаторы клиентов и операторов, связанных с заказом.
- **Информация об ошибках**: Коды ошибок и сообщения об ошибках, возникающих при обработке заказа.
- **Параметры запросов**: Параметры запросов к API, включая данные о 3D-модели.
- **Информация о сообщениях**: Идентификаторы сообщений, темы и очереди в Messages Queue.

### Мотивация

Внедрение трейсинга необходимо для повышения прозрачности и управляемости процесса обработки заказов. Это даст компании следующие преимущества:

- **Быстрое обнаружение и устранение проблем**: Трейсинг позволит оперативно выявлять проблемные заказы и определять, на каком этапе возникла проблема.
- **Сокращение времени обработки заказов**: Благодаря быстрому обнаружению и устранению проблем, среднее время обработки заказов уменьшится.
- **Повышение удовлетворенности клиентов**: Своевременное выполнение заказов повысит лояльность клиентов.
- **Оптимизация ресурсов**: Трейсинг поможет выявить узкие места в системе и оптимизировать использование ресурсов.
- **Улучшение качества обслуживания**: Анализ данных трейсинга позволит выявить типичные проблемы и улучшить качество обслуживания.

**Технические и бизнес-метрики**:

- **Время обработки заказа**: Среднее время от момента создания заказа до его завершения.
- **Количество ошибок**: Количество ошибок, возникающих при обработке заказов.
- **Время простоя**: Время, в течение которого система недоступна.
- **Удовлетворенность клиентов**: Оценка удовлетворенности клиентов качеством обслуживания.
- **Количество потерянных заказов**: Количество заказов, которые не были выполнены из-за проблем в системе.

### Предлагаемое решение

Для реализации трейсинга предлагается использовать стек **OpenTelemetry** с экспортом данных в **Jaeger**.

**Компоненты**:

- **OpenTelemetry SDK**: Интегрируется в приложения Shop API, CRM API и MES API для сбора данных трейсинга.
- **OpenTelemetry Collector**: Разворачивается как отдельный сервис для сбора, обработки и экспорта данных трейсинга.
- **Jaeger**: Разворачивается как отдельный сервис для хранения и визуализации данных трейсинга.

**Реализация**:

1. Интегрировать OpenTelemetry SDK в приложения Shop API, CRM API и MES API.
2. Настроить OpenTelemetry Collector для сбора данных от приложений и экспорта их в Jaeger.
3. Развернуть Jaeger для хранения и визуализации данных трейсинга.
4. Настроить дашборды в Jaeger для мониторинга ключевых метрик.
5. Интегрировать алертинг на основе данных трейсинга для проактивного реагирования на проблемы.

![Ссылка на схему](../jewerly_c4_model_exc_3.drawio)

### Компромиссы

Трейсинг может не принести пользы или быть невозможным в следующих случаях:

- **Отсутствие поддержки OpenTelemetry в используемых технологиях**: Если приложения написаны на языках или используют фреймворки, не поддерживаемые OpenTelemetry, внедрение трейсинга может быть затруднено или невозможно.
- **Высокая стоимость доработки проприетарных систем**: Если используются проприетарные системы, не поддерживающие экспорт метрик в нужном формате, может потребоваться дорогостоящая доработка.
- **Недостаточная детализация данных**: Если собираемые данные не содержат достаточной информации для выявления проблем, трейсинг может быть неэффективным.
- **Высокая нагрузка на систему**: Сбор и обработка данных трейсинга может создавать дополнительную нагрузку на систему, что может негативно сказаться на производительности.

### Аспекты безопасности

Для обеспечения безопасности системы трейсинга необходимо предусмотреть следующие меры:

- **Аутентификация и авторизация**: Доступ к Jaeger должен быть ограничен только авторизованными пользователями с соответствующими ролями (например, "Поддержка", "Разработчик").
- **Шифрование данных**: Данные трейсинга должны передаваться по защищенным каналам с использованием шифрования (например, HTTPS).
- **Ограничение доступа к OpenTelemetry Collector**: Доступ к OpenTelemetry Collector должен быть ограничен только доверенными приложениями и сервисами.
- **Регулярное обновление ПО**: Необходимо регулярно обновлять OpenTelemetry SDK, Collector и Jaeger для устранения уязвимостей.
- **Аудит действий пользователей**: Все действия пользователей в Jaeger должны логироваться для обеспечения возможности расследования инцидентов.

Внешний доступ к системе трейсинга не требуется.
