## Выбор и настройка мониторинга в системе


## Мотивация

Существующие проблемы:

-   **Задержки заказов:** Клиенты жалуются на просроченные заказы, что приводит к потере доверия и контрактов.
-   **Проблемы с API:** Партнеры, использующие API, также сталкиваются с задержками и ошибками.
-   **Медленная загрузка MES:** Операторы MES испытывают проблемы с загрузкой дашборда, что снижает их продуктивность.

Мониторинг позволит:

-   **Выявлять узкие места:** Определить, какие компоненты системы работают медленно или с ошибками.
-   **Прогнозировать проблемы:** Наблюдать за трендами и предотвращать сбои до того, как они повлияют на пользователей.
-   **Оптимизировать ресурсы:** Эффективно использовать вычислительные мощности и другие ресурсы.
-   **Улучшить SLA:** Обеспечить более стабильную работу системы и повысить удовлетворенность клиентов.
-   **Принимать обоснованные решения:** Использовать данные мониторинга для принятия решений о развитии и оптимизации системы.

## Выбор подхода к мониторингу

Для мониторинга предлагается использовать следующие подходы:

-   **RED (Requests, Errors, Duration)** для API (Shop API, CRM API, MES API). Этот подход позволит отслеживать количество запросов, ошибки и время отклика, что критически важно для оценки производительности и доступности API.
-   **USE (Utilization, Saturation, Errors)** для инфраструктуры (серверы, базы данных). Этот подход поможет отслеживать использование ресурсов, их насыщение и наличие ошибок, что важно для обеспечения стабильной работы системы.

## Метрики для отслеживания

### API (RED)

-   **Number of requests (RPS) for internet shop API, CRM API, MES API**
    -   *Зачем нужна эта метрика:* Позволяет отслеживать нагрузку на API и выявлять аномалии.
    -   *Ярлыки:* `api_name` (shop, crm, mes).
-   **Number of requests (RPS) per user for internet shop API, CRM API, MES API**
    -   *Зачем нужна эта метрика:* Позволяет выявить пользователей, создающих наибольшую нагрузку на API.
    -   *Ярлыки:* `api_name` (shop, crm, mes), `user_id`.
-   **Response time (latency) for shop API, CRM API, MES API**
    -   *Зачем нужна эта метрика:* Позволяет отслеживать время отклика API и выявлять замедления.
    -   *Ярлыки:* `api_name` (shop, crm, mes), `endpoint`.
-   **Number of HTTP 200 for shop API, CRM API, MES API**
    -   *Зачем нужна эта метрика:* Показывает количество успешных запросов.
    -   *Ярлыки:* `api_name` (shop, crm, mes), `endpoint`.
-   **Number of HTTP 500 for shop API, CRM API, MES API**
    -   *Зачем нужна эта метрика:* Показывает количество ошибок на стороне сервера.
    -   *Ярлыки:* `api_name` (shop, crm, mes), `endpoint`.

### Инфраструктура (USE)

-   **CPU % for shop API, CRM API, MES API**
    -   *Зачем нужна эта метрика:* Показывает загрузку процессора.
    -   *Ярлыки:* `api_name` (shop, crm, mes).
-   **Memory Utilisation for shop API, CRM API, MES API**
    -   *Зачем нужна эта метрика:* Показывает использование памяти.
    -   *Ярлыки:* `api_name` (shop, crm, mes).
-   **Memory Utilisation for shop db instance, MES db instance**
    -   *Зачем нужна эта метрика:* Показывает использование памяти базами данных.
    -   *Ярлыки:* `db_name` (shop, mes).
-   **Number of connections for shop db instance, MES db instance**
    -   *Зачем нужна эта метрика:* Показывает количество активных подключений к базам данных.
    -   *Ярлыки:* `db_name` (shop, mes).
-   **Size of S3 storage**
    -   *Зачем нужна эта метрика:* Позволяет отслеживать использование хранилища 3D моделей.
    -   *Ярлыки:* нет.
-   **Size of shop db instance, MES db instance**
    -   *Зачем нужна эта метрика:* Позволяет отслеживать рост баз данных.
    -   *Ярлыки:* `db_name` (shop, mes).

### RabbitMQ

-   **Number of dead-letter-exchange letters in RabbitMQ**
    -   *Зачем нужна эта метрика:* Показывает количество сообщений, которые не удалось обработать.
    -   *Ярлыки:* `exchange_name`.
-   **Number of message in flight in RabbitMQ**
    -   *Зачем нужна эта метрика:* Показывает количество сообщений, ожидающих обработки.
    -   *Ярлыки:* `queue_name`.

## План действий

1.  **Выбор и настройка системы мониторинга:**
    -   Определить подходящую систему мониторинга (например, Prometheus + Grafana).
    -   Развернуть систему мониторинга в облаке.
2.  **Инструментирование приложений:**
    -   Добавить в приложения (Shop API, CRM API, MES API) код для сбора метрик.
    -   Настроить экспорт метрик в систему мониторинга.
3.  **Настройка мониторинга инфраструктуры:**
    -   Настроить сбор метрик с серверов и баз данных.
    -   Настроить экспорт метрик в систему мониторинга.
4.  **Настройка мониторинга RabbitMQ:**
    -   Настроить сбор метрик с RabbitMQ.
    -   Настроить экспорт метрик в систему мониторинга.
5.  **Создание дашбордов:**
    -   Создать дашборды в Grafana для визуализации метрик.
    -   Настроить оповещения о критических значениях метрик.

## Показатели насыщенности (дополнительное задание)

### API

-   **Response time (latency):** Если среднее время отклика API превышает 500 мс в течение 5 минут, необходимо завести тикет и рассмотреть возможность оптимизации кода или масштабирования.
-   **Number of HTTP 500:** Если количество ошибок 500 превышает 5% от общего числа запросов в течение 5 минут, необходимо завести тикет и провести анализ логов.

### Инфраструктура

-   **CPU %:** Если загрузка процессора превышает 80% в течение 10 минут, необходимо завести тикет и рассмотреть возможность масштабирования.
-   **Memory Utilisation:** Если использование памяти превышает 90% в течение 10 минут, необходимо завести тикет и рассмотреть возможность масштабирования.

### RabbitMQ

-   **Number of message in flight:** Если количество сообщений в очереди превышает 1000 в течение 5 минут, необходимо завести тикет и рассмотреть возможность масштабирования обработчиков.
-   **Number of dead-letter-exchange letters:** Если количество сообщений в dead-letter-exchange превышает 100 в течение 5 минут, необходимо завести тикет и провести анализ причин.

В случае превышения пороговых значений, система должна автоматически заводить тикет в багтрекер, а также отправлять уведомление в мессенджер для оперативного реагирования.
